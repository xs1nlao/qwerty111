Техническая документация
1. Backend
Здесь определены все API эндпоинты:
/api/check-treatment (POST): Основной эндпоинт для проверки лечения. Принимает JSON с полем `history` и `patient_id`
/api/check-treatment-with-files (POST): Эндпоинт для загрузки файлов. Принимает `multipart/form-data`
/api/update-analysis (POST): Используется для обновления анализа после получения дополнительной информации от `MissingInfoCollector`
/api/patient/ : Группа эндпоинтов для управления пациентами (создание, получение, удаление, история)
/api/mammogram/analyze (POST): Эндпоинт для загрузки и анализа маммограмм
/api/metrics (GET): Возвращает собранные метрики для дашборда

2. AI Service (ai_service.py)
Этот модуль компонует всю логику взаимодействия с DeepSeek API. Ключевые методы:

detect_cancer_type(text): Отправляет промпт с просьбой классифицировать рак
extract_treatment_lines(history): Запрашивает у AI структурированный JSON с линиями терапии
ask_about_treatment(...): Используется для точечной оценки одного препарата
enhance_response_with_guidelines(...): Главная функция-оркестратор. Она объединяет результаты AI, скоринга и базы знаний, формируя финальный ответ
_check_missing_info_with_ai(...): Анализирует, достаточно ли данных для точного вывода. Если нет — генерирует структурированный список вопросов

3. Scoring (scoring.py)

ComplianceScorer

Инициализация (`__init__`): Загружает все JSON-файлы из папки `data/` с помощью `_load_protocols_from_json()`. Строит словарь `self.protocols_db`, где ключ — тип рака (`breast`, `lung`...), а значение — список протоколов (каждый протокол — это словарь с `name`, `medications`, `line`, `condition`). Определяет `drug_families` — словарь, где ключ — "каноническое" имя препарата, а значение — список его синонимов (например, `'трастузумаб': ['трастузумаб', 'герцептин', 'trastuzumab']`)
Расчет скора (`calculate_score_from_protocols`):
Принимает `cancer_type`, `treatment_lines` и `biomarkers`.
Получает список протоколов для данного `cancer_type` из `self.protocols_db`.
Если протоколов нет, вызывает `_calculate_with_ai()` для полностью AI-оценки.
Если протоколы есть, итерируется по линиям терапии. Для каждой линии вызывает `_find_matching_protocol()`, который ищет протокол, лучше всего подходящий под набор препаратов и номер линии. Внутри используется взвешенная оценка с учетом критических ошибок. Если протокол найден, вызывает `_evaluate_against_protocol()`, который сравнивает каждый препарат из линии со списком препаратов протокола (используя `_is_drug_match()` и словарь `drug_families`). Если протокол не найден, вызывает `_evaluate_line_with_ai()` для оценки этой конкретной линии через AI. Суммирует баллы с учетом веса линии (`line_weights`) и вычисляет итоговый процент.
